<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>base/class.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Application.html">Application</a><ul class='methods'><li data-type='method'><a href="Application.html#busy">busy</a></li><li data-type='method'><a href="Application.html#start">start</a></li><li data-type='method'><a href="Application.html#stop">stop</a></li><li data-type='method'><a href="Application.html#use">use</a></li></ul></li><li><a href="QueryString.html">QueryString</a><ul class='methods'><li data-type='method'><a href="QueryString.html#get">get</a></li><li data-type='method'><a href="QueryString.html#set">set</a></li><li data-type='method'><a href="QueryString.html#toJSON">toJSON</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'></ul></li><li><a href="veronica.AppPart.html">AppPart</a><ul class='methods'><li data-type='method'><a href="veronica.AppPart.html#app">app</a></li><li data-type='method'><a href="veronica.AppPart.html#loader">loader</a></li><li data-type='method'><a href="veronica.AppPart.html#logger">logger</a></li></ul></li><li><a href="veronica.AppProvider.html">AppProvider</a><ul class='methods'><li data-type='method'><a href="veronica.AppProvider.html#add">add</a></li><li data-type='method'><a href="veronica.AppProvider.html#get">get</a></li><li data-type='method'><a href="veronica.AppProvider.html#has">has</a></li><li data-type='method'><a href="veronica.AppProvider.html#remove">remove</a></li><li data-type='method'><a href="veronica.AppProvider.html#setDefault">setDefault</a></li></ul></li><li><a href="veronica.AppRouter.html">AppRouter</a><ul class='methods'></ul></li><li><a href="veronica.BaseClass.html">BaseClass</a><ul class='methods'><li data-type='method'><a href="veronica.BaseClass.html#.members">members</a></li><li data-type='method'><a href="veronica.BaseClass.html#.methods">methods</a></li><li data-type='method'><a href="veronica.BaseClass.html#.statics">statics</a></li><li data-type='method'><a href="veronica.BaseClass.html#implement">implement</a></li></ul></li><li><a href="veronica.Component.html">Component</a><ul class='methods'><li data-type='method'><a href="veronica.Component.html#$">$</a></li><li data-type='method'><a href="veronica.Component.html#active">active</a></li><li data-type='method'><a href="veronica.Component.html#children">children</a></li><li data-type='method'><a href="veronica.Component.html#destroy">destroy</a></li><li data-type='method'><a href="veronica.Component.html#hide">hide</a></li><li data-type='method'><a href="veronica.Component.html#parent">parent</a></li><li data-type='method'><a href="veronica.Component.html#parents">parents</a></li><li data-type='method'><a href="veronica.Component.html#parse">parse</a></li><li data-type='method'><a href="veronica.Component.html#render">render</a></li><li data-type='method'><a href="veronica.Component.html#reset">reset</a></li><li data-type='method'><a href="veronica.Component.html#show">show</a></li><li data-type='method'><a href="veronica.Component.html#startChildren">startChildren</a></li><li data-type='method'><a href="veronica.Component.html#stop">stop</a></li><li data-type='method'><a href="veronica.Component.html#stopChildren">stopChildren</a></li><li data-type='method'><a href="veronica.Component.html#ui">ui</a></li></ul></li><li><a href="veronica.ComponentDefManager.html">ComponentDefManager</a><ul class='methods'><li data-type='method'><a href="veronica.ComponentDefManager.html#resolve">resolve</a></li></ul></li><li><a href="veronica.ComponentManager.html">ComponentManager</a><ul class='methods'><li data-type='method'><a href="veronica.ComponentManager.html#findDom">findDom</a></li><li data-type='method'><a href="veronica.ComponentManager.html#getByDom">getByDom</a></li><li data-type='method'><a href="veronica.ComponentManager.html#isCurrBatch">isCurrBatch</a></li><li data-type='method'><a href="veronica.ComponentManager.html#register">register</a></li><li data-type='method'><a href="veronica.ComponentManager.html#start">start</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stop">stop</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stopAll">stopAll</a></li><li data-type='method'><a href="veronica.ComponentManager.html#stopByDom">stopByDom</a></li></ul></li><li><a href="veronica.History.html">History</a><ul class='methods'></ul></li><li><a href="veronica.LayoutManager.html">LayoutManager</a><ul class='methods'><li data-type='method'><a href="veronica.LayoutManager.html#change">change</a></li><li data-type='method'><a href="veronica.LayoutManager.html#init">init</a></li></ul></li><li><a href="veronica.Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="veronica.Logger.html#enable">enable</a></li><li data-type='method'><a href="veronica.Logger.html#error">error</a></li><li data-type='method'><a href="veronica.Logger.html#info">info</a></li><li data-type='method'><a href="veronica.Logger.html#log">log</a></li><li data-type='method'><a href="veronica.Logger.html#setName">setName</a></li><li data-type='method'><a href="veronica.Logger.html#time">time</a></li><li data-type='method'><a href="veronica.Logger.html#warn">warn</a></li></ul></li><li><a href="veronica.Observable.html">Observable</a><ul class='methods'><li data-type='method'><a href="veronica.Observable.html#after">after</a></li><li data-type='method'><a href="veronica.Observable.html#before">before</a></li><li data-type='method'><a href="veronica.Observable.html#listenTo">listenTo</a></li><li data-type='method'><a href="veronica.Observable.html#listenToOnce">listenToOnce</a></li><li data-type='method'><a href="veronica.Observable.html#off">off</a></li><li data-type='method'><a href="veronica.Observable.html#on">on</a></li><li data-type='method'><a href="veronica.Observable.html#once">once</a></li><li data-type='method'><a href="veronica.Observable.html#onFirst">onFirst</a></li><li data-type='method'><a href="veronica.Observable.html#stopListen">stopListen</a></li><li data-type='method'><a href="veronica.Observable.html#trigger">trigger</a></li></ul></li><li><a href="veronica.PageManager.html">PageManager</a><ul class='methods'><li data-type='method'><a href="veronica.PageManager.html#change">change</a></li><li data-type='method'><a href="veronica.PageManager.html#getCurrName">getCurrName</a></li><li data-type='method'><a href="veronica.PageManager.html#resolve">resolve</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Lodash.html">Lodash</a><ul class='methods'><li data-type='method'><a href="external-Lodash.html#.decamelize">decamelize</a></li><li data-type='method'><a href="external-Lodash.html#.ensureArray">ensureArray</a></li><li data-type='method'><a href="external-Lodash.html#.getParameterNames">getParameterNames</a></li><li data-type='method'><a href="external-Lodash.html#.mapArrayOrSingle">mapArrayOrSingle</a></li><li data-type='method'><a href="external-Lodash.html#.normalizePath">normalizePath</a></li><li data-type='method'><a href="external-Lodash.html#.safeInvoke">safeInvoke</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Application.html#event:appStarted">appStarted</a></li><li><a href="Application.html#event:componentsLoaded">componentsLoaded</a></li><li><a href="Application.html#event:layoutChanged">layoutChanged</a></li><li><a href="Application.html#event:layoutChanging">layoutChanging</a></li><li><a href="Application.html#event:pageLoaded">pageLoaded</a></li><li><a href="Application.html#event:pageLoading">pageLoading</a></li><li><a href="Application.html#event:pageNotFound">pageNotFound</a></li></ul><h3>Namespaces</h3><ul><li><a href="veronica.html">veronica</a><ul class='methods'><li data-type='method'><a href="veronica.html#.createClass">createClass</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#resolveLocation">resolveLocation</a></li><li data-type='method'><a href="Module.html#resolvePath">resolvePath</a></li></ul></li><li><a href="TemplateEngine.html">TemplateEngine</a><ul class='methods'><li data-type='method'><a href="TemplateEngine.html#compile">compile</a></li><li data-type='method'><a href="TemplateEngine.html#options">options</a></li></ul></li><li><a href="UIKit.html">UIKit</a><ul class='methods'><li data-type='method'><a href="UIKit.html#create">create</a></li><li data-type='method'><a href="UIKit.html#getInstance">getInstance</a></li><li data-type='method'><a href="UIKit.html#init">init</a></li></ul></li><li><a href="ViewEngine.html">ViewEngine</a><ul class='methods'><li data-type='method'><a href="ViewEngine.html#bind">bind</a></li><li data-type='method'><a href="ViewEngine.html#bindEvents">bindEvents</a></li><li data-type='method'><a href="ViewEngine.html#create">create</a></li><li data-type='method'><a href="ViewEngine.html#get">get</a></li><li data-type='method'><a href="ViewEngine.html#set">set</a></li><li data-type='method'><a href="ViewEngine.html#toJSON">toJSON</a></li><li data-type='method'><a href="ViewEngine.html#unbind">unbind</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">base/class.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 修改的 klass 类
 * 修改内容：
 *   - 添加继承相同属性的深拷贝合并
 *   - 添加继承函数的可选操作（可扩展可覆盖）
 *   -
 */


!function (name, context, definition) {
    if (typeof define == 'function') define(definition)
    else if (typeof module != 'undefined') module.exports = definition()
    else context[name] = definition()
}('klass', this, function () {


    // Utility - DeepExtend
    // ---------------------------

    function isSpecificValue(val) {
        return (
            val instanceof Date
            || val instanceof RegExp
        ) ? true : false;
    }

    function cloneSpecificValue(val) {
        if (val instanceof Buffer) {
            var x = new Buffer(val.length);
            val.copy(x);
            return x;
        } else if (val instanceof Date) {
            return new Date(val.getTime());
        } else if (val instanceof RegExp) {
            return new RegExp(val);
        } else {
            throw new Error('Unexpected situation');
        }
    }

    /**
     * Recursive cloning array.
     */
    function deepCloneArray(arr) {
        var clone = [];
        arr.forEach(function (item, index) {
            if (typeof item === 'object' &amp;&amp; item !== null) {
                if (Array.isArray(item)) {
                    clone[index] = deepCloneArray(item);
                } else if (isSpecificValue(item)) {
                    clone[index] = cloneSpecificValue(item);
                } else {
                    clone[index] = deepExtend({}, item);
                }
            } else {
                clone[index] = item;
            }
        });
        return clone;
    }

    /**
     * Extening object that entered in first argument.
     *
     * Returns extended object or false if have no target object or incorrect type.
     *
     * If you wish to clone source object (without modify it), just use empty new
     * object as first argument, like this:
     *   deepExtend({}, yourObj_1, [yourObj_N]);
     */
    var deepExtend = function (/*obj_1, [obj_2], [obj_N]*/) {
        if (arguments.length &lt; 1 || typeof arguments[0] !== 'object') {
            return false;
        }

        if (arguments.length &lt; 2) {
            return arguments[0];
        }

        var target = arguments[0];

        // convert arguments to array and cut off target object
        var args = Array.prototype.slice.call(arguments, 1);

        var val, src, clone;

        args.forEach(function (obj) {
            // skip argument if it is array or isn't object
            if (typeof obj !== 'object' || Array.isArray(obj)) {
                return;
            }

            Object.keys(obj).forEach(function (key) {
                src = target[key]; // source value
                val = obj[key]; // new value

                // recursion prevention
                if (val === target) {
                    return;

                    /**
                     * if new value isn't object then just overwrite by new value
                     * instead of extending.
                     */
                } else if (typeof val !== 'object' || val === null) {
                    target[key] = val;
                    return;

                    // just clone arrays (and recursive clone objects inside)
                } else if (Array.isArray(val)) {
                    target[key] = deepCloneArray(val);
                    return;

                    // custom cloning and overwrite for specific objects
                } else if (isSpecificValue(val)) {
                    target[key] = cloneSpecificValue(val);
                    return;

                    // overwrite by new value if source isn't object or array
                } else if (typeof src !== 'object' || src === null || Array.isArray(src)) {
                    target[key] = deepExtend({}, val);
                    return;

                    // source value and new value is objects both, extending...
                } else {
                    target[key] = deepExtend(src, val);
                    return;
                }
            });
        });

        return target;
    }


    //
    // ----------------------------

    var context = this;
    var f = 'function';
    var fnTest = /xyz/.test(function () { xyz }) ? /\bsupr\b/ : /.*/;

    /**
     * 创建类
     * @param {Object|function} ctor - 构造器或初始化对象
     * @returns {veronica.BaseClass}
     * @memberOf veronica
     */
    function createClass(ctor) {
        var context = isFn(ctor) ? ctor : function () { };
        return extend.call(context, ctor, 1);
    }

    function isFn(o) {
        return typeof o === f
    }

    function wrap(k, fn, supr) {
        return function () {
            var tmp = this.supr
            this.supr = supr.prototype[k]
            var undef = {}.fabricatedUndefined
            var ret = undef
            try {
                ret = fn.apply(this, arguments)
            } finally {
                this.supr = tmp
            }
            return ret
        }
    }

    function mergeMethod(original, newMethod){
        return function () {
            original.apply(this, Array.prototype.slice.call(arguments));
            newMethod.apply(this, Array.prototype.slice.call(arguments));
        }
    }

    // TODO: 这里进行精简
    function processMembers(obj, proto, supr, ext, opt){
        opt || (opt = {});
        opt.merge || (opt.merge = []);
        opt.initPropsMethod || (opt.initPropsMethod = '_initProps');

        if(ext.options){
            deepExtend(obj.options, ext.options);
        }
        if(ext.configs){
            deepExtend(obj, ext.configs);
        }
        if(ext.methods){
            process(proto, ext.methods, supr, opt.merge);
        }

        // 加入运行时属性
        if (ext.props) {
            var propMethods = {};
            var props = ext.props;
            propMethods[opt.initPropsMethod] = function () {
                var me = this;
                for(var name in props){
                    me[name] = props[name];
                }
            };
            process(proto, propMethods, supr, [opt.initPropsMethod])
        }
    }

    function process(what, o, supr, merge) {
        merge || (merge = [])

        for (var k in o) {
            if (o.hasOwnProperty(k)) {
                if (o[k] != null &amp;&amp; typeof o[k] === 'object') {
                    // 深拷贝合并对象成员
                    what[k] = deepExtend({}, supr.prototype[k], what[k], o[k])
                } else {
                    var member = o[k]
                    if(isFn(o[k])){
                        if(isFn(supr.prototype[k]) &amp;&amp; fnTest.test(o[k])){
                            member = wrap(k, o[k], supr)
                        }

                        if(isFn(what[k]) &amp;&amp; merge.indexOf(k) >= 0){
                            // 合并 function
                            member = mergeMethod(what[k], member)
                        }
                    }

                    what[k] = member
                }
            }
        }
    }

    function extend(o, fromSub) {
        // 必须重定义，以避免从以前的类继承
        function noop() { }
        noop.prototype = this.prototype;

        var supr = this;
        var subProto = new noop();  // 子类原型
        var isFunction = isFn(o);
        var _constructor = isFunction ? o : this;
        var _methods = isFunction ? {} : o;

        /**
         * 子类构造函数
         * @class
         * @memberOf veronica
         */
        function BaseClass() {
            // 调用初始化方法
            if (this.initialize) {
                this.initialize.apply(this, arguments);
            }
            else {
                if(!fromSub &amp;&amp; isFunction){
                    // 调用父类构造器
                    supr.apply(this, arguments);
                }
                // 调用传入的构造器
                _constructor.apply(this, arguments)
            }
        }

        /**
         * 扩展方法
         * @param {Object} o - 方法对象
         * @param {Array.&lt;string>} merge - 需要进行合并的方法
         * @returns {this}
         * @static
         */
        BaseClass.methods = function (o, merge) {
            process(subProto, o, supr, merge);
            BaseClass.prototype = subProto;
            return this
        };

        BaseClass.methods(_methods);

        BaseClass.prototype.constructor = BaseClass;

        /**
         * 扩展子类
         * @static
         * @example
         *  var Sub = Parent.extend({
         *    initialize: function(){
         *      this.supr()
         *    }
         *  })
         */
        BaseClass.extend = extend;

        /**
         * 添加静态属性/方法
         * @param {Object|string} o - 静态对象/属性名
         * @param {function} [optFn] - 方法
         * @static
         * @example
         *  Component.statics({
         *      'test': function() { }
         *  })
         *  Component.statics('test', function(){ })
         */
        BaseClass.statics = function (o, optFn) {
            if(typeof o == 'string'){
                o = (function () {
                    var obj = {};
                    obj[o] = optFn;
                    return obj
                }());
            }

            process(this, o, supr);
            return this;
        };

        /**
         * 为实例对象添加属性/方法
         * @function
         * @param {Object|string} o - 对象/属性名
         * @param {function} [optFn] - 方法
         * @example
         *  cmp.implement({
         *      'test': function() { }
         *  })
         *  cmp.implement('test', function(){ })
         */
        BaseClass.prototype.implement = BaseClass.statics;

        /**
         * 添加成员
         * @static
         * @param {Object} o - 扩展对象
         * @param {Object} options - 扩展参数
         * @returns {this}
         */
        BaseClass.members = function(o, options){
            processMembers(subProto, subProto, supr, o, options)
            BaseClass.prototype = subProto;
            return this
        };

        return BaseClass;
    }

    var mixins = function(target, ext, options){
        processMembers(target, target, target, ext, options)
    };


    return createClass;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
